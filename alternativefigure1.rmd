---
title: "Alternative Overview Figures"
author: "Vegard"
date: "Thursday, October 30, 2014"
output: html_document
---


Two scenarios

- Two groups, three batches. False Positives due to batch and ComBat.
- Three groups, two batches. False negatives due to batch, false positve due to mean adjust.



### False Positives due to batch and ComBat.

lage data set, 1000gener, 10+10
ingen gruppe effect eller batch effect.

1. plotte, målineg + meanstrek + CI + FC + p

2.
Dele i batcher 9+2+9, legge til batch effect.
plotte, målineg + meanstrek + CI + FC + p med batch separator i plottet.

3. Combat adjust
plotte, målineg + meanstrek + CI + FC + p uten batch separator i plottet.

4 plot med 2way anova og least square. Funker vel neppe med 1+1 bathen?

```{r}
library(sva)
source("commonscripts/helperfunctions.r")
source("commonscripts/boxplot_function_v3.r")
library(limma)
library(lsmeans)


set.seed(100)
ngenes = 1000
sampleannotation = createsampleannotation(  list(c(9,0), c(3,3), c(0,9)))
sampleannotation$batch=as.factor(sampleannotation$batch)
sampleannotation$group=as.factor(sampleannotation$group)
matrix_true = matrix(rnorm(ngenes * nrow(sampleannotation), mean=5, sd=1), nrow=ngenes, ncol=nrow(sampleannotation))

```


```{r, echo=FALSE}
plot_one_gene(matrix_true[1,], group=sampleannotation$group, main=paste("True values"),
              estimatemethod="CI")
```


Add batch effect.
```{r}
matrix_batcheffect = matrix_true
matrix_batcheffect[,sampleannotation$batch==1] = matrix_batcheffect[,sampleannotation$batch==1]+1
matrix_batcheffect[,sampleannotation$batch==3] = matrix_batcheffect[,sampleannotation$batch==3]-1
plot_one_gene(matrix_batcheffect[1,], group=sampleannotation$group, batch=sampleannotation$batch,
              main=paste("Batch affected values"), estimatemethod="CI")
```

Adjust for batch effect.
```{r}

mod0 = model.matrix(~1,data=sampleannotation)
mod = model.matrix(~as.factor(sampleannotation$group))

matrix_batchadjusted = ComBat(dat=matrix_batcheffect, batch=as.factor(sampleannotation$batch), 
                      mod=mod, numCovs=NULL, 
                      par.prior=TRUE, prior.plots=FALSE)
matrix_batchadjusted = removeBatchEffect(matrix_batcheffect, batch=as.factor(sampleannotation$batch),
                                         design=mod)

plot_one_gene(matrix_batchadjusted[1,], group=sampleannotation$group, batch=sampleannotation$batch,
              main=paste("Batch adjusted values"), estimatemethod="CI")
```

```{r}
plot_one_gene(matrix_true[1,], group=sampleannotation$group, batch=sampleannotation$batch,
              main=paste("True values, batch included in ANOVA"),estimatemethod="lsmeans")

```


```{r}
batch2FC = mean(matrix_true[1,sampleannotation$group==1 & sampleannotation$batch==2]) - 
          mean(matrix_true[1,sampleannotation$group==2 & sampleannotation$batch==2])

```


